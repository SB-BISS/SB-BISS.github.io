{"ast":null,"code":"\"use strict\";\n\nvar _slicedToArray = require(\"/home/tmaltus/Documents/BlockChainProjects/dotNetworkBlockInfo/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/slicedToArray\");\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports._referendumVotes = _referendumVotes;\nexports._referendumsVotes = _referendumsVotes;\nexports._referendumInfo = _referendumInfo;\nexports.referendumsInfo = referendumsInfo;\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _rxjs = require(\"rxjs\");\n\nvar _operators = require(\"rxjs/operators\");\n\nvar _util = require(\"@polkadot/util\");\n\nvar _util2 = require(\"../util\");\n\nvar _util3 = require(\"./util\");\n\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n    if (enumerableOnly) symbols = symbols.filter(function (sym) {\n      return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n    });\n    keys.push.apply(keys, symbols);\n  }\n\n  return keys;\n}\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n\n    if (i % 2) {\n      ownKeys(Object(source), true).forEach(function (key) {\n        (0, _defineProperty2.default)(target, key, source[key]);\n      });\n    } else if (Object.getOwnPropertyDescriptors) {\n      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));\n    } else {\n      ownKeys(Object(source)).forEach(function (key) {\n        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n      });\n    }\n  }\n\n  return target;\n}\n\nfunction votesPrev(api, referendumId) {\n  return api.query.democracy.votersFor(referendumId).pipe((0, _operators.switchMap)(function (votersFor) {\n    return (0, _rxjs.combineLatest)([(0, _rxjs.of)(votersFor), votersFor.length ? api.query.democracy.voteOf.multi(votersFor.map(function (accountId) {\n      return [referendumId, accountId];\n    })) : (0, _rxjs.of)([]), api.derive.balances.votingBalances(votersFor)]);\n  }), (0, _operators.map)(function (_ref) {\n    var _ref2 = _slicedToArray(_ref, 3),\n        votersFor = _ref2[0],\n        votes = _ref2[1],\n        balances = _ref2[2];\n\n    return votersFor.map(function (accountId, index) {\n      return {\n        accountId: accountId,\n        balance: balances[index].votingBalance || api.registry.createType('Balance'),\n        isDelegating: false,\n        vote: votes[index] || api.registry.createType('Vote')\n      };\n    });\n  }));\n}\n\nfunction extractVotes(mapped, referendumId) {\n  return mapped.filter(function (_ref3) {\n    var _ref4 = _slicedToArray(_ref3, 2),\n        voting = _ref4[1];\n\n    return voting.isDirect;\n  }).map(function (_ref5) {\n    var _ref6 = _slicedToArray(_ref5, 2),\n        accountId = _ref6[0],\n        voting = _ref6[1];\n\n    return [accountId, voting.asDirect.votes.filter(function (_ref7) {\n      var _ref8 = _slicedToArray(_ref7, 1),\n          idx = _ref8[0];\n\n      return idx.eq(referendumId);\n    })];\n  }).filter(function (_ref9) {\n    var _ref10 = _slicedToArray(_ref9, 2),\n        directVotes = _ref10[1];\n\n    return !!directVotes.length;\n  }).reduce(function (result, _ref11) {\n    var _ref12 = _slicedToArray(_ref11, 2),\n        accountId = _ref12[0],\n        votes = _ref12[1];\n\n    return (// FIXME We are ignoring split votes\n      votes.reduce(function (result, _ref13) {\n        var _ref14 = _slicedToArray(_ref13, 2),\n            vote = _ref14[1];\n\n        if (vote.isStandard) {\n          result.push(_objectSpread({\n            accountId: accountId,\n            isDelegating: false\n          }, vote.asStandard));\n        }\n\n        return result;\n      }, result)\n    );\n  }, []);\n}\n\nfunction votesCurr(api, referendumId) {\n  return api.query.democracy.votingOf.entries().pipe((0, _operators.map)(function (allVoting) {\n    var mapped = allVoting.map(function (_ref15) {\n      var _ref16 = _slicedToArray(_ref15, 2),\n          key = _ref16[0],\n          voting = _ref16[1];\n\n      return [key.args[0], voting];\n    });\n    var votes = extractVotes(mapped, referendumId);\n    var delegations = mapped.filter(function (_ref17) {\n      var _ref18 = _slicedToArray(_ref17, 2),\n          voting = _ref18[1];\n\n      return voting.isDelegating;\n    }).map(function (_ref19) {\n      var _ref20 = _slicedToArray(_ref19, 2),\n          accountId = _ref20[0],\n          voting = _ref20[1];\n\n      return [accountId, voting.asDelegating];\n    }); // add delegations\n\n    delegations.forEach(function (_ref21) {\n      var _ref22 = _slicedToArray(_ref21, 2),\n          accountId = _ref22[0],\n          _ref22$ = _ref22[1],\n          balance = _ref22$.balance,\n          conviction = _ref22$.conviction,\n          target = _ref22$.target;\n\n      // Are we delegating to a delegator\n      var toDelegator = delegations.find(function (_ref23) {\n        var _ref24 = _slicedToArray(_ref23, 1),\n            accountId = _ref24[0];\n\n        return accountId.eq(target);\n      });\n      var to = votes.find(function (_ref25) {\n        var accountId = _ref25.accountId;\n        return accountId.eq(toDelegator ? toDelegator[0] : target);\n      }); // this delegation has a target\n\n      if (to) {\n        votes.push({\n          accountId: accountId,\n          balance: balance,\n          isDelegating: true,\n          vote: api.registry.createType('Vote', {\n            aye: to.vote.isAye,\n            conviction: conviction\n          })\n        });\n      }\n    });\n    return votes;\n  }));\n}\n\nfunction _referendumVotes(instanceId, api) {\n  return (0, _util2.memo)(instanceId, function (referendum) {\n    return (0, _rxjs.combineLatest)([api.derive.democracy.sqrtElectorate(), (0, _util.isFunction)(api.query.democracy.votingOf) ? votesCurr(api, referendum.index) : votesPrev(api, referendum.index)]).pipe((0, _operators.map)(function (_ref26) {\n      var _ref27 = _slicedToArray(_ref26, 2),\n          sqrtElectorate = _ref27[0],\n          votes = _ref27[1];\n\n      return (0, _util3.calcVotes)(sqrtElectorate, referendum, votes);\n    }));\n  });\n}\n\nfunction _referendumsVotes(instanceId, api) {\n  return (0, _util2.memo)(instanceId, function (referendums) {\n    return referendums.length ? (0, _rxjs.combineLatest)(referendums.map(function (referendum) {\n      return api.derive.democracy._referendumVotes(referendum);\n    })) : (0, _rxjs.of)([]);\n  });\n}\n\nfunction _referendumInfo(instanceId, api) {\n  return (0, _util2.memo)(instanceId, function (index, info) {\n    var status = (0, _util3.getStatus)(info);\n    return status ? api.query.democracy.preimages(status.proposalHash).pipe((0, _operators.map)(function (preimage) {\n      return {\n        image: (0, _util3.parseImage)(api, preimage),\n        imageHash: status.proposalHash,\n        index: api.registry.createType('ReferendumIndex', index),\n        status: status\n      };\n    })) : (0, _rxjs.of)(null);\n  });\n}\n\nfunction referendumsInfo(instanceId, api) {\n  return (0, _util2.memo)(instanceId, function (ids) {\n    return ids.length ? api.query.democracy.referendumInfoOf.multi(ids).pipe((0, _operators.switchMap)(function (infos) {\n      return (0, _rxjs.combineLatest)(ids.map(function (id, index) {\n        return api.derive.democracy._referendumInfo(id, infos[index]);\n      }));\n    }), (0, _operators.map)(function (infos) {\n      return infos.filter(function (referendum) {\n        return !!referendum;\n      });\n    })) : (0, _rxjs.of)([]);\n  });\n}","map":{"version":3,"sources":["/home/tmaltus/Documents/BlockChainProjects/dotNetworkBlockInfo/node_modules/@polkadot/api-derive/democracy/referendumsInfo.js"],"names":["_interopRequireDefault","require","Object","defineProperty","exports","value","_referendumVotes","_referendumsVotes","_referendumInfo","referendumsInfo","_defineProperty2","_rxjs","_operators","_util","_util2","_util3","ownKeys","object","enumerableOnly","keys","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","key","default","getOwnPropertyDescriptors","defineProperties","votesPrev","api","referendumId","query","democracy","votersFor","pipe","switchMap","combineLatest","of","voteOf","multi","map","accountId","derive","balances","votingBalances","votes","index","balance","votingBalance","registry","createType","isDelegating","vote","extractVotes","mapped","voting","isDirect","asDirect","idx","eq","directVotes","reduce","result","isStandard","asStandard","votesCurr","votingOf","entries","allVoting","args","delegations","asDelegating","conviction","toDelegator","find","to","aye","isAye","instanceId","memo","referendum","sqrtElectorate","isFunction","calcVotes","referendums","info","status","getStatus","preimages","proposalHash","preimage","image","parseImage","imageHash","ids","referendumInfoOf","infos","id"],"mappings":"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","sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports._referendumVotes = _referendumVotes;\nexports._referendumsVotes = _referendumsVotes;\nexports._referendumInfo = _referendumInfo;\nexports.referendumsInfo = referendumsInfo;\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _rxjs = require(\"rxjs\");\n\nvar _operators = require(\"rxjs/operators\");\n\nvar _util = require(\"@polkadot/util\");\n\nvar _util2 = require(\"../util\");\n\nvar _util3 = require(\"./util\");\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction votesPrev(api, referendumId) {\n  return api.query.democracy.votersFor(referendumId).pipe((0, _operators.switchMap)(votersFor => (0, _rxjs.combineLatest)([(0, _rxjs.of)(votersFor), votersFor.length ? api.query.democracy.voteOf.multi(votersFor.map(accountId => [referendumId, accountId])) : (0, _rxjs.of)([]), api.derive.balances.votingBalances(votersFor)])), (0, _operators.map)(([votersFor, votes, balances]) => votersFor.map((accountId, index) => ({\n    accountId,\n    balance: balances[index].votingBalance || api.registry.createType('Balance'),\n    isDelegating: false,\n    vote: votes[index] || api.registry.createType('Vote')\n  }))));\n}\n\nfunction extractVotes(mapped, referendumId) {\n  return mapped.filter(([, voting]) => voting.isDirect).map(([accountId, voting]) => [accountId, voting.asDirect.votes.filter(([idx]) => idx.eq(referendumId))]).filter(([, directVotes]) => !!directVotes.length).reduce((result, [accountId, votes]) => // FIXME We are ignoring split votes\n  votes.reduce((result, [, vote]) => {\n    if (vote.isStandard) {\n      result.push(_objectSpread({\n        accountId,\n        isDelegating: false\n      }, vote.asStandard));\n    }\n\n    return result;\n  }, result), []);\n}\n\nfunction votesCurr(api, referendumId) {\n  return api.query.democracy.votingOf.entries().pipe((0, _operators.map)(allVoting => {\n    const mapped = allVoting.map(([key, voting]) => [key.args[0], voting]);\n    const votes = extractVotes(mapped, referendumId);\n    const delegations = mapped.filter(([, voting]) => voting.isDelegating).map(([accountId, voting]) => [accountId, voting.asDelegating]); // add delegations\n\n    delegations.forEach(([accountId, {\n      balance,\n      conviction,\n      target\n    }]) => {\n      // Are we delegating to a delegator\n      const toDelegator = delegations.find(([accountId]) => accountId.eq(target));\n      const to = votes.find(({\n        accountId\n      }) => accountId.eq(toDelegator ? toDelegator[0] : target)); // this delegation has a target\n\n      if (to) {\n        votes.push({\n          accountId,\n          balance,\n          isDelegating: true,\n          vote: api.registry.createType('Vote', {\n            aye: to.vote.isAye,\n            conviction\n          })\n        });\n      }\n    });\n    return votes;\n  }));\n}\n\nfunction _referendumVotes(instanceId, api) {\n  return (0, _util2.memo)(instanceId, referendum => (0, _rxjs.combineLatest)([api.derive.democracy.sqrtElectorate(), (0, _util.isFunction)(api.query.democracy.votingOf) ? votesCurr(api, referendum.index) : votesPrev(api, referendum.index)]).pipe((0, _operators.map)(([sqrtElectorate, votes]) => (0, _util3.calcVotes)(sqrtElectorate, referendum, votes))));\n}\n\nfunction _referendumsVotes(instanceId, api) {\n  return (0, _util2.memo)(instanceId, referendums => referendums.length ? (0, _rxjs.combineLatest)(referendums.map(referendum => api.derive.democracy._referendumVotes(referendum))) : (0, _rxjs.of)([]));\n}\n\nfunction _referendumInfo(instanceId, api) {\n  return (0, _util2.memo)(instanceId, (index, info) => {\n    const status = (0, _util3.getStatus)(info);\n    return status ? api.query.democracy.preimages(status.proposalHash).pipe((0, _operators.map)(preimage => ({\n      image: (0, _util3.parseImage)(api, preimage),\n      imageHash: status.proposalHash,\n      index: api.registry.createType('ReferendumIndex', index),\n      status\n    }))) : (0, _rxjs.of)(null);\n  });\n}\n\nfunction referendumsInfo(instanceId, api) {\n  return (0, _util2.memo)(instanceId, ids => ids.length ? api.query.democracy.referendumInfoOf.multi(ids).pipe((0, _operators.switchMap)(infos => (0, _rxjs.combineLatest)(ids.map((id, index) => api.derive.democracy._referendumInfo(id, infos[index])))), (0, _operators.map)(infos => infos.filter(referendum => !!referendum))) : (0, _rxjs.of)([]));\n}"]},"metadata":{},"sourceType":"script"}